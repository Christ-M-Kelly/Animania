{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 76, "column": 0}, "map": {"version":3,"sources":["file:///Users/moaye_kelly/WebstormProjects/Animania/app/api/posts/route.ts"],"sourcesContent":["import { PrismaClient } from \"@prisma/client\";\nimport jwt from \"jsonwebtoken\";\nimport { NextRequest, NextResponse } from \"next/server\";\n\nconst prisma = new PrismaClient();\n\nexport async function GET(request: NextRequest) {\n  try {\n    const searchParams = request.nextUrl.searchParams;\n    const limit = parseInt(searchParams.get(\"limit\") || \"100\");\n    const category = searchParams.get(\"category\");\n\n    // V√©rifier si c'est une requ√™te authentifi√©e pour voir les brouillons\n    const authHeader = request.headers.get(\"authorization\");\n    let userId: string | null = null;\n    let showDrafts = false;\n\n    if (authHeader) {\n      try {\n        const token = authHeader.replace(\"Bearer \", \"\");\n        const decoded = jwt.verify(token, process.env.JWT_SECRET!) as {\n          userId: string;\n        };\n        userId = decoded.userId;\n        showDrafts = searchParams.get(\"drafts\") === \"true\";\n      } catch (error) {\n        console.log(\"Token invalide ou expir√©\");\n      }\n    }\n\n    console.log(\"üì• GET /api/posts - Params:\", {\n      limit,\n      category,\n      showDrafts,\n      userId,\n    });\n\n    // Construction des filtres - TOUJOURS filtrer par published pour les requ√™tes publiques\n    const where: any = {\n      published: true, // Par d√©faut, on ne montre que les articles publi√©s\n    };\n\n    // Si l'utilisateur demande explicitement ses brouillons ET est authentifi√©\n    if (showDrafts && userId) {\n      where.published = false;\n      where.authorId = userId;\n    }\n\n    if (category && category !== \"all\") {\n      where.category = category;\n    }\n\n    const posts = await prisma.post.findMany({\n      where,\n      include: {\n        author: {\n          select: {\n            id: true,\n            name: true,\n            email: true,\n          },\n        },\n        _count: {\n          select: {\n            comments: true,\n          },\n        },\n      },\n      orderBy: {\n        createdAt: \"desc\",\n      },\n      take: limit,\n    });\n\n    console.log(\"‚úÖ Posts r√©cup√©r√©s:\", posts.length);\n\n    return NextResponse.json({\n      success: true,\n      posts,\n      count: posts.length,\n    });\n  } catch (error) {\n    console.error(\"‚ùå Erreur GET posts:\", error);\n    return NextResponse.json(\n      {\n        success: false,\n        error: \"Erreur lors de la r√©cup√©ration des articles\",\n        message: error instanceof Error ? error.message : \"Erreur inconnue\",\n      },\n      { status: 500 }\n    );\n  }\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    const body = await request.json();\n    console.log(\"üì• Donn√©es re√ßues:\", body);\n\n    let authorId = body.authorId;\n\n    // V√©rification du token si pr√©sent\n    const authHeader = request.headers.get(\"authorization\");\n    if (authHeader) {\n      try {\n        const token = authHeader.replace(\"Bearer \", \"\");\n        const decoded = jwt.verify(token, process.env.JWT_SECRET!) as {\n          userId: string;\n        };\n        authorId = decoded.userId;\n        console.log(\"‚úÖ Token valide, authorId:\", authorId);\n      } catch (tokenError) {\n        console.log(\"‚ö†Ô∏è Token invalide, utilisation de l'authorId fourni\");\n      }\n    }\n\n    // Validation des donn√©es requises\n    const { title, content, category, published = false } = body;\n\n    if (!title?.trim()) {\n      return NextResponse.json(\n        {\n          success: false,\n          message: \"Le titre est requis\",\n        },\n        { status: 400 }\n      );\n    }\n\n    if (!content?.trim()) {\n      return NextResponse.json(\n        {\n          success: false,\n          message: \"Le contenu est requis\",\n        },\n        { status: 400 }\n      );\n    }\n\n    if (!category) {\n      return NextResponse.json(\n        {\n          success: false,\n          message: \"La cat√©gorie est requise\",\n        },\n        { status: 400 }\n      );\n    }\n\n    if (!authorId) {\n      return NextResponse.json(\n        {\n          success: false,\n          message: \"L'auteur est requis\",\n        },\n        { status: 400 }\n      );\n    }\n\n    // V√©rifier que l'auteur existe\n    const authorExists = await prisma.user.findUnique({\n      where: { id: authorId },\n    });\n\n    if (!authorExists) {\n      return NextResponse.json(\n        {\n          success: false,\n          message: \"Auteur non trouv√©\",\n        },\n        { status: 404 }\n      );\n    }\n\n    // Cr√©ation du post\n    const post = await prisma.post.create({\n      data: {\n        title: title.trim(),\n        content: content.trim(),\n        excerpt: body.excerpt?.trim() || null,\n        category: category,\n        imageUrl: body.imageUrl || null,\n        published: Boolean(published),\n        authorId: authorId,\n      },\n      include: {\n        author: {\n          select: {\n            id: true,\n            name: true,\n            email: true,\n          },\n        },\n      },\n    });\n\n    console.log(\n      \"‚úÖ Post cr√©√© avec succ√®s:\",\n      post.id,\n      \"- Publi√©:\",\n      post.published\n    );\n\n    return NextResponse.json(\n      {\n        success: true,\n        message: \"Article cr√©√© avec succ√®s\",\n        post,\n      },\n      { status: 201 }\n    );\n  } catch (error) {\n    console.error(\"‚ùå Erreur lors de la cr√©ation du post:\", error);\n\n    if (error instanceof Error) {\n      return NextResponse.json(\n        {\n          success: false,\n          message: \"Erreur lors de la cr√©ation\",\n          error: error.message,\n        },\n        { status: 500 }\n      );\n    }\n\n    return NextResponse.json(\n      {\n        success: false,\n        message: \"Erreur serveur inconnue\",\n      },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":"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"}}]
}